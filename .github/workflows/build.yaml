name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: ['**']
  workflow_dispatch:
    inputs:
      force-publish:
        description: 'Force publish even if no version change was detected'
        required: false
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'

defaults:
  run:
    shell: bash -el {0}

jobs:
  populate-cache:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{steps.cache-key.outputs.cache-key}}-0
    steps:
      - name: Get Date
        id: get-date
        run: |
          echo "date=$(date +'%Y-%b')"
          echo "date=$(date +'%Y-%b')" >> $GITHUB_OUTPUT
      - id: cache-key
        run: echo "cache-key=test-${{steps.get-date.outputs.date}}" >> $GITHUB_OUTPUT
      - uses: actions/cache/restore@v4
        id: look-up
        with:
          path: bioimageio_cache
          key: ${{steps.cache-key.outputs.cache-key}}
          lookup-only: true
      - uses: actions/checkout@v4
        if: steps.look-up.outputs.cache-hit != 'true'
      - uses: ./.github/actions/max_disk_space
        if: steps.look-up.outputs.cache-hit != 'true'
      - uses: actions/cache@v4
        if: steps.look-up.outputs.cache-hit != 'true'
        with:
          path: bioimageio_cache
          key: ${{steps.cache-key.outputs.cache-key}}
      - uses: actions/setup-python@v6
        if: steps.look-up.outputs.cache-hit != 'true'
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        if: steps.look-up.outputs.cache-hit != 'true'
        run: |
          pip install -e .[dev]
      - run: pytest --disable-pytest-warnings tests/test_bioimageio_collection.py::test_rdf_format_to_populate_cache
        if: steps.look-up.outputs.cache-hit != 'true'
        env:
          BIOIMAGEIO_POPULATE_CACHE: '1'
          BIOIMAGEIO_CACHE_PATH: bioimageio_cache
  test:
    needs: populate-cache
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - python-version: '3.9'
            numpy-version: 1
          - python-version: '3.9'
            numpy-version: 2
          - python-version: '3.10'
            run-expensive-tests: true
            report-coverage: true
            save-cache: true
            numpy-version: 1
          - python-version: '3.11'
            numpy-version: 2
          - python-version: '3.12'
            numpy-version: 1
          # - python-version: '3.13'
          #   numpy-version: 2

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/max_disk_space
      - uses: actions/setup-python@v6
        with:
          python-version: ${{matrix.python-version}}
          cache: 'pip'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev,partners] numpy==${{matrix.numpy-version}}.*
      - name: Pyright
        if: matrix.run-expensive-tests # pyright is not expensive, but we only want to run it once due to otherwise inconsistent typing
        run: |
          pyright --version
          pyright -p pyproject.toml --pythonversion ${{ matrix.python-version }}
      - name: Restore bioimageio cache ${{needs.populate-cache.outputs.cache-key}}
        uses: actions/cache/restore@v4
        with:
          path: bioimageio_cache
          key: ${{needs.populate-cache.outputs.cache-key}}
      - name: pytest
        run: pytest --cov bioimageio.core --cov-append --capture no --disable-pytest-warnings
        env:
          BIOIMAGEIO_CACHE_PATH: bioimageio_cache
          RUN_EXPENSIVE_TESTS: ${{ matrix.run-expensive-tests && 'true' || 'false' }}
      - name: Save bioimageio cache ${{needs.populate-cache.outputs.cache-key}}
        if: matrix.save-cache
        uses: actions/cache/save@v4
        with:
          path: bioimageio_cache
          key: ${{needs.populate-cache.outputs.cache-key}}

      - run: cp .coverage .coverage.${{matrix.python-version}}-${{matrix.numpy-version}}
      - uses: actions/upload-artifact@v4
        with:
          name: .coverage.${{matrix.python-version}}-${{matrix.numpy-version}}
          retention-days: 1
          path: .coverage.${{matrix.python-version}}-${{matrix.numpy-version}}
          include-hidden-files: true

  coverage:
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
      - run: |
          pip install coverage
      - uses: actions/download-artifact@v4
        with:
          pattern: .coverage.*
          merge-multiple: true
      - run: |
          ls -la .coverage*
          coverage combine
          coverage xml -o coverage.xml
      - uses: orgoro/coverage@v3.2
        with:
          coverageFile: coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          thresholdAll: 0.7
          thresholdNew: 0.9
          thresholdModified: 0.6
      - name: generate coverage badge and html report
        run: |
          pip install genbadge[coverage]
          genbadge coverage --input-file coverage.xml --output-file ./dist/coverage/coverage-badge.svg
          coverage html -d dist/coverage
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: dist

  conda-build:
    needs: [populate-cache, test] # only so we run tests even if the pinned bioimageio.spec version is not yet published on conda-forge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate-base: true
          activate-environment: ''
          channel-priority: strict
          miniforge-version: latest
          conda-solver: libmamba
      - name: install common conda dependencies
        run: conda install -n base -c conda-forge conda-build -y
      - uses: actions/cache@v4
        with:
          path: |
            pkgs/noarch
            pkgs/channeldata.json
          key: ${{ github.sha }}-packages
      - uses: actions/cache@v4
        with:
          path: bioimageio_cache
          key: ${{needs.populate-cache.outputs.cache-key}}
      - name: linux conda build test
        shell: bash -l {0}
        run: |
          mkdir -p ./pkgs/noarch
          conda-build -c conda-forge conda-recipe --output-folder ./pkgs
        env:
          BIOIMAGEIO_CACHE_PATH: bioimageio_cache

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
      - name: Install dependencies
        run: pip install --upgrade build
      - name: Build package
        run: python -m build
      - uses: actions/upload-artifact@v4
        with:
          path: dist/
          name: dist

  docs:
    needs: [build, conda-build, coverage, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write # required for tag creation
    outputs:
      new-version: ${{ steps.get-new-version.outputs.new-version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - uses: ./.github/actions/max_disk_space
      - uses: actions/download-artifact@v4
        with:
          name: coverage-summary
          path: dist
      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -e .[dev,docs,partners]
      - name: Get branch name to deploy to
        id: get_branch
        shell: bash
        run: |
          if [[ -n '${{ github.event.pull_request.head.ref }}' ]]; then branch=gh-pages-${{ github.event.pull_request.head.ref }}; else branch=gh-pages; fi
          echo "::set-output name=branch::$branch"
      - name: Get parent commit
        if: inputs.force-publish != 'true'
        id: get-parent-commit
        run: |
          echo "sha=$(git rev-parse --verify --quiet HEAD^)" >> $GITHUB_OUTPUT
      - id: get-existing-tag
        if: inputs.force-publish == 'true'
        run: echo "existing-tag=$(git tag --points-at HEAD 'v[0-9]*.[0-9]*.[0-9]*')" >> $GITHUB_OUTPUT
      - name: Detect new version from last commit and create tag
        id: tag-version
        if: github.ref == 'refs/heads/main' && steps.get-parent-commit.outputs.sha && inputs.force-publish != 'true'
        uses: salsify/action-detect-and-tag-new-version@v2.0.3
        with:
          create-tag: true
          version-command: |
            python -c "from pathlib import Path; p = Path('src/bioimageio/core/__init__.py'); v = p.read_text().split('__version__ = \"')[1].split('\"')[0]; print(v)"
      - shell: python
        id: get-new-version
        run: |
          import os
          from pathlib import Path

          if "${{ inputs.force-publish }}" == "true":
              existing_tag = "${{ steps.get-existing-tag.outputs.existing-tag }}"
              valid = existing_tag.count("v") == 1 and existing_tag.count(".") == 2 and all(part.isdigit() for part in existing_tag.lstrip("v").split("."))
              if not valid:
                  raise Exception(f"Current commit has invalid version tag {existing_tag}.")

              source_version = Path('src/bioimageio/core/__init__.py').read_text().split('__version__ = \"')[1].split('\"')[0]
              if existing_tag != f"v{source_version}":
                  raise Exception(f"Version tag {existing_tag} does not match source version {source_version}.")

              new_version = existing_tag
          else:
              new_version = "${{ steps.tag-version.outputs.tag }}"

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              print(f"new-version={new_version}", file=f)
      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - name: Generate developer docs
        run: mike deploy --push --branch ${{ steps.get_branch.outputs.branch }} --update-aliases ${{ steps.get-new-version.outputs.new-version || 'dev'}} ${{ steps.get-new-version.outputs.new-version && 'latest' || ' '}}
      - name: copy rendered presentations
        run: |
          mkdir ./dist/presentations
          cp -r ./presentations/*.html ./dist/presentations/
      - name: Deploy to gh-pages ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: dist
          clean: true
          clean-exclude: |
            .nojekyll
            index.html
            versions.json
            latest/
            dev/
            v0.*/

  publish:
    needs: [test, coverage, build, conda-build, docs]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.docs.outputs.new-version
    environment:
      name: release
      url: https://pypi.org/project/bioimageio.core/
    permissions:
      contents: write # required to create a github release (release drafter)
      id-token: write # required for pypi publish action
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - name: Publish package on PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
      - name: Publish the release notes
        uses: release-drafter/release-drafter@v6.0.0
        with:
          tag: '${{ needs.docs.outputs.new-version }}'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
